<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard SSP-SC - Seguran√ßa P√∫blica de Santa Catarina</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- jsPDF para exporta√ß√£o em PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
            margin-bottom: 20px;
        }
        .stat-card {
            text-align: center;
            padding: 20px;
        }
        .stat-card h3 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-card p {
            color: #6c757d;
            margin-bottom: 0;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .loading.active {
            display: block;
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shield-check"></i>
                Dashboard SSP-SC - Nova Vers√£o
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#historico" data-bs-toggle="tab">
                            <i class="bi bi-clock-history"></i> Hist√≥rico
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="atualizarDados">
                            <i class="bi bi-arrow-clockwise"></i> Atualizar
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard">Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="relatorios-tab" data-bs-toggle="tab" href="#relatorios">Relat√≥rios</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="historico-tab" data-bs-toggle="tab" href="#historico">Hist√≥rico de Execu√ß√µes</a>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard">
                <!-- Filtros -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="bi bi-funnel"></i> Filtros
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="filtrosForm">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label for="filtroCategoria" class="form-label">Categoria</label>
                                    <select class="form-select" id="filtroCategoria" name="categoria">
                                        <option value="todas">Todas</option>
                                        <option value="roubo">Roubo</option>
                                        <option value="furto">Furto</option>
                                        <option value="mortes_violentas">Mortes Violentas</option>
                                        <option value="homicidio">Homic√≠dio</option>
                                        <option value="violencia_domestica">Viol√™ncia Dom√©stica</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="filtroMunicipio" class="form-label">Munic√≠pio</label>
                                    <select class="form-select" id="filtroMunicipio" name="municipio">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="filtroRegiao" class="form-label">Regi√£o</label>
                                    <select class="form-select" id="filtroRegiao" name="regiao">
                                        <option value="">Todas</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="filtroAno" class="form-label">Ano</label>
                                    <select class="form-select" id="filtroAno" name="ano">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="filtroMes" class="form-label">M√™s</label>
                                    <select class="form-select" id="filtroMes" name="mes">
                                        <option value="">Todos</option>
                                        <option value="1">Janeiro</option>
                                        <option value="2">Fevereiro</option>
                                        <option value="3">Mar√ßo</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Maio</option>
                                        <option value="6">Junho</option>
                                        <option value="7">Julho</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Setembro</option>
                                        <option value="10">Outubro</option>
                                        <option value="11">Novembro</option>
                                        <option value="12">Dezembro</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-search"></i> Aplicar Filtros
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="limparFiltros">
                                        <i class="bi bi-x-circle"></i> Limpar
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div class="loading" id="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando dados...</p>
                </div>

                <!-- Estat√≠sticas -->
                <div class="row mb-4" id="estatisticas">
                    <div class="col-md-3">
                        <div class="card stat-card bg-primary text-white">
                            <h3 id="statTotalOcorrencias">0</h3>
                            <p>Total de Ocorr√™ncias</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-success text-white">
                            <h3 id="statTotalRegistros">0</h3>
                            <p>Total de Registros</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-info text-white">
                            <h3 id="statMunicipios">0</h3>
                            <p>Munic√≠pios Afetados</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-warning text-white">
                            <h3 id="statMedia">0</h3>
                            <p>M√©dia por Munic√≠pio</p>
                        </div>
                    </div>
                </div>

                <!-- Gr√°ficos -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Ocorr√™ncias por Categoria</h6>
                            </div>
                            <div class="card-body">
                                <div id="graficoCategoria"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Top 15 Munic√≠pios</h6>
                            </div>
                            <div class="card-body">
                                <div id="graficoMunicipio"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Evolu√ß√£o Temporal</h6>
                            </div>
                            <div class="card-body">
                                <div id="graficoTemporal"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Comparativo entre Categorias</h6>
                            </div>
                            <div class="card-body">
                                <div id="graficoComparativo"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relat√≥rios Tab -->
            <div class="tab-pane fade" id="relatorios">
                <!-- Filtros (mesmos do Dashboard) -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="bi bi-funnel"></i> Filtros
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="filtrosFormRelatorio">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label for="filtroRelatorioCategoria" class="form-label">Categoria</label>
                                    <select class="form-select" id="filtroRelatorioCategoria" name="categoria">
                                        <option value="todas">Todas</option>
                                        <option value="roubo">Roubo</option>
                                        <option value="furto">Furto</option>
                                        <option value="mortes_violentas">Mortes Violentas</option>
                                        <option value="homicidio">Homic√≠dio</option>
                                        <option value="violencia_domestica">Viol√™ncia Dom√©stica</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="filtroRelatorioMunicipio" class="form-label">Munic√≠pio</label>
                                    <select class="form-select" id="filtroRelatorioMunicipio" name="municipio">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="filtroRelatorioRegiao" class="form-label">Regi√£o</label>
                                    <select class="form-select" id="filtroRelatorioRegiao" name="regiao">
                                        <option value="">Todas</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="filtroRelatorioAno" class="form-label">Ano</label>
                                    <select class="form-select" id="filtroRelatorioAno" name="ano">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="filtroRelatorioMes" class="form-label">M√™s</label>
                                    <select class="form-select" id="filtroRelatorioMes" name="mes">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-search"></i> Gerar Relat√≥rio
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="limparFiltrosRelatorio">
                                        <i class="bi bi-x-circle"></i> Limpar
                                    </button>
                                    <button type="button" class="btn btn-success" id="exportarRelatorio">
                                        <i class="bi bi-file-earmark-spreadsheet"></i> Exportar CSV
                                    </button>
                                    <button type="button" class="btn btn-danger" id="exportarRelatorioPDF">
                                        <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Resultados do Relat√≥rio -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-file-earmark-text"></i> Relat√≥rio de Dados
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="relatorioLoading" class="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-2">Gerando relat√≥rio...</p>
                        </div>

                        <div id="relatorioResultados" style="display:none;">
                            <div class="alert alert-info mb-3">
                                <strong>Total de registros:</strong> <span id="totalRegistrosRelatorio">0</span>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm" id="tabelaRelatorio">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Ano</th>
                                            <th>M√™s</th>
                                            <th>Munic√≠pio</th>
                                            <th>Regi√£o</th>
                                            <th>Categoria</th>
                                            <th>Tipo</th>
                                            <th>Quantidade</th>
                                            <th>Data Coleta</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaRelatorioBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="relatorioVazio" style="display:none;">
                            <div class="alert alert-warning">
                                <i class="bi bi-info-circle"></i> Nenhum dado encontrado com os filtros selecionados.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hist√≥rico Tab -->
            <div class="tab-pane fade" id="historico">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history"></i> Hist√≥rico de Execu√ß√µes
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Status</th>
                                        <th>Tipo</th>
                                        <th>Anos</th>
                                        <th>Inseridos</th>
                                        <th>Ignorados</th>
                                        <th>Mensagem</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaHistorico">
                                    <tr>
                                        <td colspan="7" class="text-center">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Fun√ß√£o para mostrar/ocultar loading
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        // Fun√ß√£o para carregar filtros
        async function carregarFiltros() {
            try {
                const response = await fetch('/api/filtros');
                const data = await response.json();

                if (data.success) {
                    // Preencher munic√≠pios
                    const selectMunicipio = document.getElementById('filtroMunicipio');
                    selectMunicipio.innerHTML = '<option value="">Todos</option>';
                    data.filtros.municipios.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m;
                        option.textContent = m;
                        selectMunicipio.appendChild(option);
                    });

                    // Preencher regi√µes
                    const selectRegiao = document.getElementById('filtroRegiao');
                    selectRegiao.innerHTML = '<option value="">Todas</option>';
                    data.filtros.regioes.forEach(r => {
                        const option = document.createElement('option');
                        option.value = r;
                        option.textContent = r;
                        selectRegiao.appendChild(option);
                    });

                    // Preencher anos
                    const selectAno = document.getElementById('filtroAno');
                    selectAno.innerHTML = '<option value="">Todos</option>';
                    data.filtros.anos.forEach(a => {
                        const option = document.createElement('option');
                        option.value = a;
                        option.textContent = a;
                        selectAno.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar filtros:', error);
            }
        }

        // Fun√ß√£o para carregar estat√≠sticas
        async function carregarEstatisticas(filtros = {}) {
            try {
                const params = new URLSearchParams(filtros);
                const response = await fetch(`/api/estatisticas?${params}`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('statTotalOcorrencias').textContent =
                        data.estatisticas.total_ocorrencias.toLocaleString();
                    document.getElementById('statTotalRegistros').textContent =
                        data.estatisticas.total_registros.toLocaleString();
                    document.getElementById('statMunicipios').textContent =
                        data.estatisticas.municipios_afetados;
                    document.getElementById('statMedia').textContent =
                        Math.round(data.estatisticas.media_por_municipio);
                }
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
            }
        }

        // Fun√ß√£o para carregar gr√°ficos
        async function carregarGraficos(filtros = {}) {
            showLoading(true);

            try {
                const params = new URLSearchParams(filtros);

                // Gr√°fico por categoria
                const resCategoria = await fetch(`/api/grafico/ocorrencias-por-categoria?${params}`);
                const dataCategoria = await resCategoria.json();
                if (dataCategoria.success) {
                    Plotly.newPlot('graficoCategoria', JSON.parse(dataCategoria.grafico).data,
                        JSON.parse(dataCategoria.grafico).layout);
                }

                // Gr√°fico por munic√≠pio
                const resMunicipio = await fetch(`/api/grafico/ocorrencias-por-municipio?${params}`);
                const dataMunicipio = await resMunicipio.json();
                if (dataMunicipio.success) {
                    Plotly.newPlot('graficoMunicipio', JSON.parse(dataMunicipio.grafico).data,
                        JSON.parse(dataMunicipio.grafico).layout);
                }

                // Gr√°fico temporal
                const resTemporal = await fetch(`/api/grafico/evolucao-temporal?${params}`);
                const dataTemporal = await resTemporal.json();
                if (dataTemporal.success) {
                    Plotly.newPlot('graficoTemporal', JSON.parse(dataTemporal.grafico).data,
                        JSON.parse(dataTemporal.grafico).layout);
                }

                // Gr√°fico comparativo
                const resComparativo = await fetch(`/api/grafico/comparativo-categorias?${params}`);
                const dataComparativo = await resComparativo.json();
                if (dataComparativo.success) {
                    Plotly.newPlot('graficoComparativo', JSON.parse(dataComparativo.grafico).data,
                        JSON.parse(dataComparativo.grafico).layout);
                }

            } catch (error) {
                console.error('Erro ao carregar gr√°ficos:', error);
            } finally {
                showLoading(false);
            }
        }

        // Fun√ß√£o para carregar hist√≥rico
        async function carregarHistorico() {
            try {
                const response = await fetch('/api/historico');
                const data = await response.json();

                const tbody = document.getElementById('tabelaHistorico');
                tbody.innerHTML = '';

                if (data.success && data.historico.length > 0) {
                    data.historico.forEach(item => {
                        const tr = document.createElement('tr');

                        const dataHora = new Date(item.data_hora_inicio).toLocaleString('pt-BR');
                        const statusBadge = item.status === 'sucesso' ? 'bg-success' :
                                          item.status === 'erro' ? 'bg-danger' : 'bg-warning';

                        tr.innerHTML = `
                            <td>${dataHora}</td>
                            <td><span class="badge ${statusBadge}">${item.status}</span></td>
                            <td>${item.tipo_dados}</td>
                            <td>${item.anos_processados || '-'}</td>
                            <td>${item.registros_inseridos || 0}</td>
                            <td>${item.registros_ignorados || 0}</td>
                            <td>${item.mensagem || '-'}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum registro encontrado</td></tr>';
                }
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
            }
        }

        // Event listeners
        document.getElementById('filtrosForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const filtros = Object.fromEntries(formData.entries());

            // Remover filtros vazios
            Object.keys(filtros).forEach(key => {
                if (!filtros[key]) delete filtros[key];
            });

            carregarEstatisticas(filtros);
            carregarGraficos(filtros);
        });

        document.getElementById('limparFiltros').addEventListener('click', function() {
            document.getElementById('filtrosForm').reset();
            carregarEstatisticas();
            carregarGraficos();
        });

        document.getElementById('atualizarDados').addEventListener('click', function(e) {
            e.preventDefault();
            location.reload();
        });

        // Carregar hist√≥rico quando a tab √© ativada
        document.getElementById('historico-tab').addEventListener('click', function() {
            carregarHistorico();
        });

        // ===== FUN√á√ïES DA ABA RELAT√ìRIOS =====

        // Carregar filtros na aba Relat√≥rios
        function carregarFiltrosRelatorio() {
            fetch('/api/filtros')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const filtros = data.filtros;

                        // Preencher munic√≠pios
                        const selectMunicipio = document.getElementById('filtroRelatorioMunicipio');
                        selectMunicipio.innerHTML = '<option value="">Todos</option>';
                        filtros.municipios.forEach(m => {
                            selectMunicipio.innerHTML += `<option value="${m}">${m}</option>`;
                        });

                        // Preencher regi√µes
                        const selectRegiao = document.getElementById('filtroRelatorioRegiao');
                        selectRegiao.innerHTML = '<option value="">Todas</option>';
                        filtros.regioes.forEach(r => {
                            selectRegiao.innerHTML += `<option value="${r}">${r}</option>`;
                        });

                        // Preencher anos
                        const selectAno = document.getElementById('filtroRelatorioAno');
                        selectAno.innerHTML = '<option value="">Todos</option>';
                        filtros.anos.forEach(a => {
                            selectAno.innerHTML += `<option value="${a}">${a}</option>`;
                        });
                    }
                })
                .catch(error => console.error('Erro ao carregar filtros:', error));
        }

        // Gerar relat√≥rio
        function gerarRelatorio(filtros) {
            const loadingRelatorio = document.getElementById('relatorioLoading');
            const resultadosRelatorio = document.getElementById('relatorioResultados');
            const tabelaRelatorioBody = document.getElementById('tabelaRelatorioBody');
            const emptyStateRelatorio = document.getElementById('relatorioVazio');
            const totalRegistrosSpan = document.getElementById('totalRegistrosRelatorio');

            // Mostrar loading
            loadingRelatorio.style.display = 'block';
            resultadosRelatorio.style.display = 'none';
            emptyStateRelatorio.style.display = 'none';

            // Construir query string
            const params = new URLSearchParams();
            Object.keys(filtros).forEach(key => {
                if (filtros[key]) params.append(key, filtros[key]);
            });

            fetch(`/api/dados?${params}`)
                .then(response => response.json())
                .then(data => {
                    loadingRelatorio.style.display = 'none';

                    if (data.success && data.dados && data.dados.length > 0) {
                        let registros = data.dados;

                        // Limpar tabela
                        tabelaRelatorioBody.innerHTML = '';

                        // Processar registros para agrupamento
                        registros = registros.map(registro => {
                            // Determinar categoria
                            let categoria = registro.categoria || '';
                            if (!categoria) {
                                if (registro.tipo_homicidio) categoria = 'Homic√≠dio';
                                else if (registro.tipo_roubo) categoria = 'Roubo';
                                else if (registro.tipo_furto) categoria = 'Furto';
                                else if (registro.tipo_morte) categoria = 'Mortes Violentas';
                                else if (registro.tipo_violencia) categoria = 'Viol√™ncia Dom√©stica';
                            }

                            // Determinar tipo espec√≠fico
                            const tipo = registro.tipo_homicidio || registro.tipo_roubo ||
                                       registro.tipo_furto || registro.tipo_morte ||
                                       registro.tipo_violencia || '-';

                            // Para dados estaduais agregados, exibir de forma mais clara
                            let municipio = registro.municipio || '-';
                            let regiao = registro.regiao || '-';

                            if (municipio === 'Santa Catarina' && regiao === 'Estado') {
                                municipio = '(Todo o Estado)';
                                regiao = 'Santa Catarina';
                            }

                            return {
                                ...registro,
                                categoria_display: categoria,
                                tipo_display: tipo,
                                municipio_display: municipio,
                                regiao_display: regiao,
                                ano: registro.ano || 0,
                                mes: registro.mes || 0
                            };
                        });

                        // Ordenar por: Munic√≠pio, Ano, M√™s
                        registros.sort((a, b) => {
                            // Primeiro por munic√≠pio
                            if (a.municipio_display < b.municipio_display) return -1;
                            if (a.municipio_display > b.municipio_display) return 1;
                            // Depois por ano
                            if (a.ano < b.ano) return -1;
                            if (a.ano > b.ano) return 1;
                            // Depois por m√™s
                            if (a.mes < b.mes) return -1;
                            if (a.mes > b.mes) return 1;
                            return 0;
                        });

                        // Calcular totais por munic√≠pio e tipo
                        const totaisPorMunicipioTipo = {};
                        registros.forEach(registro => {
                            const chaveMunicipio = registro.municipio_display;
                            const chaveTipo = `${registro.categoria_display} - ${registro.tipo_display}`;

                            if (!totaisPorMunicipioTipo[chaveMunicipio]) {
                                totaisPorMunicipioTipo[chaveMunicipio] = {};
                            }

                            if (!totaisPorMunicipioTipo[chaveMunicipio][chaveTipo]) {
                                totaisPorMunicipioTipo[chaveMunicipio][chaveTipo] = 0;
                            }

                            totaisPorMunicipioTipo[chaveMunicipio][chaveTipo] += (registro.quantidade || 0);
                        });

                        // Preencher tabela com agrupamento
                        let municipioAtual = null;

                        registros.forEach((registro, index) => {
                            // Adicionar linha de separa√ß√£o para novo munic√≠pio
                            if (municipioAtual !== registro.municipio_display) {
                                municipioAtual = registro.municipio_display;

                                const separatorRow = document.createElement('tr');
                                separatorRow.className = 'table-primary';
                                separatorRow.innerHTML = `
                                    <td colspan="8" class="fw-bold">
                                        <i class="bi bi-geo-alt-fill"></i> ${municipioAtual}
                                    </td>
                                `;
                                tabelaRelatorioBody.appendChild(separatorRow);
                            }

                            // Linha de dados
                            const row = document.createElement('tr');
                            const ano = registro.ano || '-';
                            const mes = registro.mes || '-';
                            const quantidade = registro.quantidade || 0;
                            const dataColeta = registro.data_coleta ?
                                new Date(registro.data_coleta).toLocaleDateString('pt-BR') : '-';

                            row.innerHTML = `
                                <td>${ano}</td>
                                <td>${mes}</td>
                                <td>${registro.municipio_display}</td>
                                <td>${registro.regiao_display}</td>
                                <td>${registro.categoria_display}</td>
                                <td>${registro.tipo_display}</td>
                                <td class="text-end">${quantidade.toLocaleString('pt-BR')}</td>
                                <td>${dataColeta}</td>
                            `;

                            tabelaRelatorioBody.appendChild(row);

                            // Verificar se √© o √∫ltimo registro deste munic√≠pio
                            const isUltimoDoMunicipio = (index === registros.length - 1) ||
                                                       (registros[index + 1].municipio_display !== municipioAtual);

                            // Adicionar linha de subtotais ao final de cada munic√≠pio
                            if (isUltimoDoMunicipio) {
                                const totaisMunicipio = totaisPorMunicipioTipo[municipioAtual];

                                // Criar linhas de subtotal por tipo
                                Object.entries(totaisMunicipio).forEach(([tipo, total]) => {
                                    const subtotalRow = document.createElement('tr');
                                    subtotalRow.className = 'table-warning fw-bold';
                                    subtotalRow.innerHTML = `
                                        <td colspan="5" class="text-end">Subtotal ${municipioAtual} - ${tipo}:</td>
                                        <td></td>
                                        <td class="text-end">${total.toLocaleString('pt-BR')}</td>
                                        <td></td>
                                    `;
                                    tabelaRelatorioBody.appendChild(subtotalRow);
                                });
                            }
                        });

                        // Adicionar totais gerais ao final do relat√≥rio
                        const totaisGeraisPorTipo = {};
                        registros.forEach(registro => {
                            const chaveTipo = `${registro.categoria_display} - ${registro.tipo_display}`;
                            if (!totaisGeraisPorTipo[chaveTipo]) {
                                totaisGeraisPorTipo[chaveTipo] = 0;
                            }
                            totaisGeraisPorTipo[chaveTipo] += (registro.quantidade || 0);
                        });

                        // Linha separadora antes dos totais gerais
                        const separadorTotaisRow = document.createElement('tr');
                        separadorTotaisRow.className = 'table-dark';
                        separadorTotaisRow.innerHTML = `
                            <td colspan="8" class="fw-bold text-center">
                                <i class="bi bi-calculator"></i> TOTAIS GERAIS
                            </td>
                        `;
                        tabelaRelatorioBody.appendChild(separadorTotaisRow);

                        // Linhas de totais gerais por tipo
                        Object.entries(totaisGeraisPorTipo).sort((a, b) => a[0].localeCompare(b[0])).forEach(([tipo, total]) => {
                            const totalGeralRow = document.createElement('tr');
                            totalGeralRow.className = 'table-success fw-bold';
                            totalGeralRow.innerHTML = `
                                <td colspan="5" class="text-end">Total Geral - ${tipo}:</td>
                                <td></td>
                                <td class="text-end">${total.toLocaleString('pt-BR')}</td>
                                <td></td>
                            `;
                            tabelaRelatorioBody.appendChild(totalGeralRow);
                        });

                        // Total geral absoluto (soma de tudo)
                        const totalAbsoluto = Object.values(totaisGeraisPorTipo).reduce((sum, val) => sum + val, 0);
                        const totalAbsolutoRow = document.createElement('tr');
                        totalAbsolutoRow.className = 'table-danger fw-bold';
                        totalAbsolutoRow.style.fontSize = '1.1em';
                        totalAbsolutoRow.innerHTML = `
                            <td colspan="5" class="text-end">TOTAL GERAL ABSOLUTO:</td>
                            <td></td>
                            <td class="text-end">${totalAbsoluto.toLocaleString('pt-BR')}</td>
                            <td></td>
                        `;
                        tabelaRelatorioBody.appendChild(totalAbsolutoRow);

                        // Atualizar contador de registros
                        totalRegistrosSpan.textContent = registros.length;

                        resultadosRelatorio.style.display = 'block';
                    } else {
                        emptyStateRelatorio.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Erro ao gerar relat√≥rio:', error);
                    loadingRelatorio.style.display = 'none';
                    emptyStateRelatorio.style.display = 'block';
                });
        }

        // Exportar relat√≥rio para CSV
        function exportarRelatorioCSV() {
            const tabela = document.getElementById('tabelaRelatorioBody');
            const rows = tabela.getElementsByTagName('tr');

            if (rows.length === 0) {
                alert('Nenhum dado dispon√≠vel para exportar. Gere um relat√≥rio primeiro.');
                return;
            }

            // Cabe√ßalho CSV
            const headers = ['Ano', 'M√™s', 'Munic√≠pio', 'Regi√£o', 'Categoria', 'Tipo', 'Quantidade', 'Data Coleta'];
            let csvContent = headers.join(';') + '\n';

            // Adicionar linhas (pular linhas de agrupamento)
            Array.from(rows).forEach(row => {
                // Pular linhas de cabe√ßalho de munic√≠pio (que t√™m colspan="8")
                const cells = row.getElementsByTagName('td');
                if (cells.length === 1 && cells[0].getAttribute('colspan') === '8') {
                    return; // Pular linha de agrupamento
                }
                const rowData = Array.from(cells).map(cell => {
                    let value = cell.textContent.trim();
                    // Escapar aspas e adicionar aspas se contiver ponto e v√≠rgula
                    if (value.includes(';') || value.includes('"') || value.includes('\n')) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csvContent += rowData.join(';') + '\n';
            });

            // Criar arquivo e download
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            link.setAttribute('href', url);
            link.setAttribute('download', `relatorio_ssp_sc_${timestamp}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Exportar relat√≥rio para PDF
        function exportarRelatorioPDF() {
            const tabela = document.getElementById('tabelaRelatorioBody');
            const rows = tabela.getElementsByTagName('tr');

            if (rows.length === 0) {
                alert('Nenhum dado dispon√≠vel para exportar. Gere um relat√≥rio primeiro.');
                return;
            }

            // Coletar dados para o PDF
            const dadosPDF = [];
            let municipioAtual = '';

            Array.from(rows).forEach(row => {
                const cells = row.getElementsByTagName('td');

                // Verificar se √© linha de agrupamento
                if (cells.length === 1 && cells[0].getAttribute('colspan') === '8') {
                    municipioAtual = cells[0].textContent.trim().replace('üìç ', '');
                    return;
                }

                // Linha de dados
                if (cells.length === 8) {
                    const rowData = [
                        cells[0].textContent.trim(), // Ano
                        cells[1].textContent.trim(), // M√™s
                        cells[2].textContent.trim(), // Munic√≠pio
                        cells[3].textContent.trim(), // Regi√£o
                        cells[4].textContent.trim(), // Categoria
                        cells[5].textContent.trim(), // Tipo
                        cells[6].textContent.trim(), // Quantidade
                        cells[7].textContent.trim()  // Data Coleta
                    ];
                    dadosPDF.push(rowData);
                }
            });

            if (dadosPDF.length === 0) {
                alert('Nenhum dado dispon√≠vel para exportar.');
                return;
            }

            // Criar PDF usando jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });

            // T√≠tulo
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Relat√≥rio SSP-SC - Seguran√ßa P√∫blica de Santa Catarina', 15, 15);

            // Data de gera√ß√£o
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const dataGeracao = new Date().toLocaleString('pt-BR');
            doc.text(`Gerado em: ${dataGeracao}`, 15, 22);

            // Tabela
            doc.autoTable({
                head: [['Ano', 'M√™s', 'Munic√≠pio', 'Regi√£o', 'Categoria', 'Tipo', 'Quantidade', 'Data Coleta']],
                body: dadosPDF,
                startY: 28,
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                    overflow: 'linebreak',
                    halign: 'left'
                },
                headStyles: {
                    fillColor: [41, 128, 185],
                    textColor: 255,
                    fontStyle: 'bold',
                    halign: 'center'
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                margin: { top: 28, right: 10, bottom: 10, left: 10 },
                theme: 'grid',
                columnStyles: {
                    0: { cellWidth: 15 },  // Ano
                    1: { cellWidth: 12 },  // M√™s
                    2: { cellWidth: 40 },  // Munic√≠pio
                    3: { cellWidth: 30 },  // Regi√£o
                    4: { cellWidth: 35 },  // Categoria
                    5: { cellWidth: 35 },  // Tipo
                    6: { cellWidth: 20, halign: 'right' },  // Quantidade
                    7: { cellWidth: 25 }   // Data Coleta
                },
                didDrawPage: function (data) {
                    // Rodap√© com n√∫mero de p√°gina
                    const pageCount = doc.internal.getNumberOfPages();
                    const pageNumber = doc.internal.getCurrentPageInfo().pageNumber;
                    doc.setFontSize(8);
                    doc.text(
                        `P√°gina ${pageNumber} de ${pageCount}`,
                        doc.internal.pageSize.getWidth() / 2,
                        doc.internal.pageSize.getHeight() - 10,
                        { align: 'center' }
                    );
                }
            });

            // Salvar PDF
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            doc.save(`relatorio_ssp_sc_${timestamp}.pdf`);
        }

        // Event listeners da aba Relat√≥rios
        document.getElementById('relatorios-tab').addEventListener('click', function() {
            carregarFiltrosRelatorio();
        });

        document.getElementById('filtrosFormRelatorio').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const filtros = Object.fromEntries(formData.entries());

            // Converter categoria "todas" para vazio (buscar tudo)
            if (filtros.categoria === 'todas') {
                delete filtros.categoria;
            }

            // Remover filtros vazios
            Object.keys(filtros).forEach(key => {
                if (!filtros[key]) delete filtros[key];
            });

            gerarRelatorio(filtros);
        });

        document.getElementById('limparFiltrosRelatorio').addEventListener('click', function() {
            document.getElementById('filtrosFormRelatorio').reset();
            document.getElementById('relatorioResultados').style.display = 'none';
            document.getElementById('relatorioVazio').style.display = 'none';
            document.getElementById('relatorioLoading').style.display = 'none';
        });

        document.getElementById('exportarRelatorio').addEventListener('click', function(e) {
            e.preventDefault();
            exportarRelatorioCSV();
        });

        document.getElementById('exportarRelatorioPDF').addEventListener('click', function(e) {
            e.preventDefault();
            exportarRelatorioPDF();
        });

        // Inicializar ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            carregarFiltros();
            carregarEstatisticas();
            carregarGraficos();
        });
    </script>
</body>
</html>

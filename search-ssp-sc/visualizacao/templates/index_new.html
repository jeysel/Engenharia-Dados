<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard SSP-SC - Segurança Pública de Santa Catarina</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
            margin-bottom: 20px;
        }
        .stat-card {
            text-align: center;
            padding: 20px;
        }
        .stat-card h3 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-card p {
            color: #6c757d;
            margin-bottom: 0;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .loading.active {
            display: block;
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shield-check"></i>
                Dashboard SSP-SC - Nova Versão
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#historico" data-bs-toggle="tab">
                            <i class="bi bi-clock-history"></i> Histórico
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="atualizarDados">
                            <i class="bi bi-arrow-clockwise"></i> Atualizar
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard">Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="historico-tab" data-bs-toggle="tab" href="#historico">Histórico de Execuções</a>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard">
                <!-- Filtros -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="bi bi-funnel"></i> Filtros
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="filtrosForm">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label for="filtroCategoria" class="form-label">Categoria</label>
                                    <select class="form-select" id="filtroCategoria" name="categoria">
                                        <option value="todas">Todas</option>
                                        <option value="roubo">Roubo</option>
                                        <option value="furto">Furto</option>
                                        <option value="mortes_violentas">Mortes Violentas</option>
                                        <option value="homicidio">Homicídio</option>
                                        <option value="violencia_domestica">Violência Doméstica</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="filtroMunicipio" class="form-label">Município</label>
                                    <select class="form-select" id="filtroMunicipio" name="municipio">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="filtroRegiao" class="form-label">Região</label>
                                    <select class="form-select" id="filtroRegiao" name="regiao">
                                        <option value="">Todas</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="filtroAno" class="form-label">Ano</label>
                                    <select class="form-select" id="filtroAno" name="ano">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="filtroMes" class="form-label">Mês</label>
                                    <select class="form-select" id="filtroMes" name="mes">
                                        <option value="">Todos</option>
                                        <option value="1">Janeiro</option>
                                        <option value="2">Fevereiro</option>
                                        <option value="3">Março</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Maio</option>
                                        <option value="6">Junho</option>
                                        <option value="7">Julho</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Setembro</option>
                                        <option value="10">Outubro</option>
                                        <option value="11">Novembro</option>
                                        <option value="12">Dezembro</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-search"></i> Aplicar Filtros
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="limparFiltros">
                                        <i class="bi bi-x-circle"></i> Limpar
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div class="loading" id="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando dados...</p>
                </div>

                <!-- Estatísticas -->
                <div class="row mb-4" id="estatisticas">
                    <div class="col-md-3">
                        <div class="card stat-card bg-primary text-white">
                            <h3 id="statTotalOcorrencias">0</h3>
                            <p>Total de Ocorrências</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-success text-white">
                            <h3 id="statTotalRegistros">0</h3>
                            <p>Total de Registros</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-info text-white">
                            <h3 id="statMunicipios">0</h3>
                            <p>Municípios Afetados</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-warning text-white">
                            <h3 id="statMedia">0</h3>
                            <p>Média por Município</p>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Ocorrências por Categoria</h6>
                            </div>
                            <div class="card-body">
                                <div id="graficoCategoria"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Top 15 Municípios</h6>
                            </div>
                            <div class="card-body">
                                <div id="graficoMunicipio"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Evolução Temporal</h6>
                            </div>
                            <div class="card-body">
                                <div id="graficoTemporal"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Comparativo entre Categorias</h6>
                            </div>
                            <div class="card-body">
                                <div id="graficoComparativo"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Histórico Tab -->
            <div class="tab-pane fade" id="historico">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history"></i> Histórico de Execuções
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Status</th>
                                        <th>Tipo</th>
                                        <th>Anos</th>
                                        <th>Inseridos</th>
                                        <th>Ignorados</th>
                                        <th>Mensagem</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaHistorico">
                                    <tr>
                                        <td colspan="7" class="text-center">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Função para mostrar/ocultar loading
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        // Função para carregar filtros
        async function carregarFiltros() {
            try {
                const response = await fetch('/api/filtros');
                const data = await response.json();

                if (data.success) {
                    // Preencher municípios
                    const selectMunicipio = document.getElementById('filtroMunicipio');
                    selectMunicipio.innerHTML = '<option value="">Todos</option>';
                    data.filtros.municipios.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m;
                        option.textContent = m;
                        selectMunicipio.appendChild(option);
                    });

                    // Preencher regiões
                    const selectRegiao = document.getElementById('filtroRegiao');
                    selectRegiao.innerHTML = '<option value="">Todas</option>';
                    data.filtros.regioes.forEach(r => {
                        const option = document.createElement('option');
                        option.value = r;
                        option.textContent = r;
                        selectRegiao.appendChild(option);
                    });

                    // Preencher anos
                    const selectAno = document.getElementById('filtroAno');
                    selectAno.innerHTML = '<option value="">Todos</option>';
                    data.filtros.anos.forEach(a => {
                        const option = document.createElement('option');
                        option.value = a;
                        option.textContent = a;
                        selectAno.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar filtros:', error);
            }
        }

        // Função para carregar estatísticas
        async function carregarEstatisticas(filtros = {}) {
            try {
                const params = new URLSearchParams(filtros);
                const response = await fetch(`/api/estatisticas?${params}`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('statTotalOcorrencias').textContent =
                        data.estatisticas.total_ocorrencias.toLocaleString();
                    document.getElementById('statTotalRegistros').textContent =
                        data.estatisticas.total_registros.toLocaleString();
                    document.getElementById('statMunicipios').textContent =
                        data.estatisticas.municipios_afetados;
                    document.getElementById('statMedia').textContent =
                        Math.round(data.estatisticas.media_por_municipio);
                }
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // Função para carregar gráficos
        async function carregarGraficos(filtros = {}) {
            showLoading(true);

            try {
                const params = new URLSearchParams(filtros);

                // Gráfico por categoria
                const resCategoria = await fetch(`/api/grafico/ocorrencias-por-categoria?${params}`);
                const dataCategoria = await resCategoria.json();
                if (dataCategoria.success) {
                    Plotly.newPlot('graficoCategoria', JSON.parse(dataCategoria.grafico).data,
                        JSON.parse(dataCategoria.grafico).layout);
                }

                // Gráfico por município
                const resMunicipio = await fetch(`/api/grafico/ocorrencias-por-municipio?${params}`);
                const dataMunicipio = await resMunicipio.json();
                if (dataMunicipio.success) {
                    Plotly.newPlot('graficoMunicipio', JSON.parse(dataMunicipio.grafico).data,
                        JSON.parse(dataMunicipio.grafico).layout);
                }

                // Gráfico temporal
                const resTemporal = await fetch(`/api/grafico/evolucao-temporal?${params}`);
                const dataTemporal = await resTemporal.json();
                if (dataTemporal.success) {
                    Plotly.newPlot('graficoTemporal', JSON.parse(dataTemporal.grafico).data,
                        JSON.parse(dataTemporal.grafico).layout);
                }

                // Gráfico comparativo
                const resComparativo = await fetch(`/api/grafico/comparativo-categorias?${params}`);
                const dataComparativo = await resComparativo.json();
                if (dataComparativo.success) {
                    Plotly.newPlot('graficoComparativo', JSON.parse(dataComparativo.grafico).data,
                        JSON.parse(dataComparativo.grafico).layout);
                }

            } catch (error) {
                console.error('Erro ao carregar gráficos:', error);
            } finally {
                showLoading(false);
            }
        }

        // Função para carregar histórico
        async function carregarHistorico() {
            try {
                const response = await fetch('/api/historico');
                const data = await response.json();

                const tbody = document.getElementById('tabelaHistorico');
                tbody.innerHTML = '';

                if (data.success && data.historico.length > 0) {
                    data.historico.forEach(item => {
                        const tr = document.createElement('tr');

                        const dataHora = new Date(item.data_hora_inicio).toLocaleString('pt-BR');
                        const statusBadge = item.status === 'sucesso' ? 'bg-success' :
                                          item.status === 'erro' ? 'bg-danger' : 'bg-warning';

                        tr.innerHTML = `
                            <td>${dataHora}</td>
                            <td><span class="badge ${statusBadge}">${item.status}</span></td>
                            <td>${item.tipo_dados}</td>
                            <td>${item.anos_processados || '-'}</td>
                            <td>${item.registros_inseridos || 0}</td>
                            <td>${item.registros_ignorados || 0}</td>
                            <td>${item.mensagem || '-'}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum registro encontrado</td></tr>';
                }
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
            }
        }

        // Event listeners
        document.getElementById('filtrosForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const filtros = Object.fromEntries(formData.entries());

            // Remover filtros vazios
            Object.keys(filtros).forEach(key => {
                if (!filtros[key]) delete filtros[key];
            });

            carregarEstatisticas(filtros);
            carregarGraficos(filtros);
        });

        document.getElementById('limparFiltros').addEventListener('click', function() {
            document.getElementById('filtrosForm').reset();
            carregarEstatisticas();
            carregarGraficos();
        });

        document.getElementById('atualizarDados').addEventListener('click', function(e) {
            e.preventDefault();
            location.reload();
        });

        // Carregar histórico quando a tab é ativada
        document.getElementById('historico-tab').addEventListener('click', function() {
            carregarHistorico();
        });

        // Inicializar ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            carregarFiltros();
            carregarEstatisticas();
            carregarGraficos();
        });
    </script>
</body>
</html>
